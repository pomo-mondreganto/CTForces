{% load staticfiles %}
<div class="sidebar">
    <div class="contest_sidebar">
        {% for contest in upcoming_contests %}
            {{contest.title}}
        {% endfor %}
        {{upcoming_contests.length}}
    </div>
    {% if request.user.is_authenticated %}
	    <div class="user_sidebar">
	        <div class="user_sidebar_header"><i class="fas fa-user"></i> {{ request.user.username }}</div>
	        <div class="user_sidebar_main">
	        	<div class="user_sidebar_avatar">
                    <a href="{% url 'user_info' request.user.username %}">
                        <img src="{{ request.user.avatar.small.url }}" alt=""
                             onerror="this.onerror=null;this.src='{{ settings.DEFAULT_AVATAR_SMALL }}'">
                    </a>
	        	</div>
	        	<i class="fas fa-chart-line"></i> Rating: 
	        	<div class="user_sidebar_rating"><div class="rank-color-{{ request.user.rank }}">{{ request.user.rating }}</div></div>
	        	<ul class="user_sidebar_list">
                    <li><a href="{% url 'user_info' request.user.username %}">Profile</a></li>
                    <li><a href="{% url 'settings_general_view' %}">Settings</a></li>
                    <li><a href="{% url 'user_blog_view' request.user.username %}">Blog</a></li>
                    <li><a href="#">Grekov</a></li>
	        	</ul>
	        </div>
	    </div>
    {% endif %}
    <div class="rating_sidebar">
        <div class="rating_sidebar_header"><i class="fas fa-trophy"></i> Top rated</div>
        <table>
        	<thead>
        		<tr>
        			<th class="rating_sidebar_table_header_number">#</th>
        			<th class="rating_sidebar_table_header_user">User</th>
        			<th class="rating_sidebar_table_header_rating">Rating</th>
        		</tr>
        	</thead>
        	<tbody>
        		{% for user in top_users %}
	        		<tr>
	        			<td class="rating_sidebar_table_number">{{ forloop.counter }}</td>
	        			    <td class="rating_sidebar_table_user">
                                <a class="top_user_td_url" href="{% url 'user_info' user.username %}">
                                    <div class="rank-color-{{ user.rank }}">{{ user.username }}</div>
                                </a>
                            </td>
	        			<td class="rating_sidebar_table_rating">{{ user.rating }}</td>
	        		</tr>
        		{% endfor %}
        	</tbody>
        </table>
    </div>
    <div class="find_user_sidebar">
    	<div class="find_user_sidebar_header"><i class="fas fa-search"></i> Find user</div>
        <div class="find_user_sidebar_input"><input class="find_user_sidebar_input_field" type="text" name="username" placeholder="Handle" /></div>
        <table class="find_user_hint_table">
        	<thead>
        		<tr>
        			<th>
        				<div class="find_user_hint_table_header">
        					Possible variants
        				</div>
        			</th>
        		</tr>
        	</thead>
			<tbody>
			</tbody>
        </table>
        <div class="find_user_sidebar_button"><input type="submit" value="Search" /></div>
    </div>
</div>

<script>

    $(".find_user_sidebar_input_field").on("input", function() {
        $.get({
            url: "/search_users/",
            data: {
                "username": $(".find_user_sidebar_input_field").val()
            },
            success: function(data) {
                var users = data["objects"];
                var current = $(".find_user_sidebar_input_field").val();
                if (users.length == 0 || (users.length == 1 && users[0] == current)) {
                    $(".find_user_hint_table").hide();
                }
                else {
                    $(".find_user_hint_table > tbody").empty();
                    for (var i = 0; i < users.length; i += 1) {
                        $(".find_user_hint_table > tbody:last-child").append('<tr><td class="find_user_hint_table_td" user="' + users[i] + '">' + users[i] + '</td></tr>');
                    }
                    $(".find_user_hint_table").show();
                }
            },
            error: function(status, exception) {
                 $(".find_user_hint_table").hide();
            }
        });
    });

    $(".find_user_sidebar_input_field").keyup(function(event) {
        if (event.keyCode === 13) {
            $(".find_user_sidebar_button").click();
        }
    });

    $(".find_user_hint_table").on("click", "td", function() {
        $(".find_user_sidebar_input_field").val($(this).attr("user"));
        $(".find_user_sidebar_input_field").trigger("input");
    });

    $(".find_user_sidebar_button").click(function() {
        $(location).attr("href", "/user/" + $(".find_user_sidebar_input_field").val() + "/");
    });
    
</script>