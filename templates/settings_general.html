{% extends "base.html" %}
{% load staticfiles %}

{% block content %}

    <div class="main">
        <div class="container">
            <div class="main_content">
                <div class="row">
                    <div class="main_page_content">
                        <div class="wall">
                        	{% include "user_sidebar.html" %}
                            <div class="user_box_roundbox">
                            	<div class="user_box">
                            		<div class="settings_menu">
                            			<div class="settings_show_username_field">
                            				{{ request.user.username }}
                            			</div>
                            			<input id="settings_load_avatar_input" type="file" name="avatar" data-url="{% url 'settings_general_view' %}" />
										<input id="settings_load_avatar" type="button" value="Load avatar"/>
										<div id="file_upload_bar"></div>
										<form id="settings_general_form" method="post" enctype="multipart/form-data">

											{% csrf_token %}
											{% for message in messages %}
												{% if 'avatar' in message.tags %}
													<div class="settings_error">{{ message }}</div>
												{% endif %}
											{% endfor %}
                                            <input type="text" name="email" placeholder="Email" {% if request.user.email %}value="{{ request.user.email }}"{% endif %}/>
											{% for message in messages %}
												{% if 'email' in message.tags %}
													<div class="settings_error">{{ message }}</div>
												{% endif %}
											{% endfor %}
											<input type="password" name="old_password" placeholder="Old password" />
											{% for message in messages %}
												{% if 'old_password' in message.tags %}
													<div class="settings_error">{{ message }}</div>
												{% endif %}
											{% endfor %}
											<input type="password" name="new_password" placeholder="New password" />
											{% for message in messages %}
												{% if 'new_password' in message.tags %}
													<div class="settings_error">{{ message }}</div>
												{% endif %}
											{% endfor %}
											<div class="settings_show_hint">Leave it blank if you do not want to change the password</div>
											<input type="password" name="new_password2" placeholder="Retype new password" />
											{% for message in messages %}
												{% if 'new_password2' in message.tags %}
													<div class="settings_error">{{ message }}</div>
												{% endif %}
											{% endfor %}
											
											<input type="submit" value="Change settings" />

										</form>
									</div>
                            	</div>
                            </div>
                        </div>

                        {% include "sidebar.html" %}

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    	var settings_general_files = new Array();

	    $(function () {
	        $('#settings_load_avatar_input').fileupload({
	            dataType: 'text',
	            autoUpload: false,
	            add: function(e, data) {
	                $.each(data.files, function(index, file) {
	                    settings_general_files.push(data.files[index]);
	                });
	            },
	            done: function(e, data) {
	                window.location.reload(false); 
	            },
	            fail: function(e, data) {
	                if (data._response.jqXHR.status == 403) {
	                    window.location.href = {% url 'signin' %} + '?next=' + window.location.pathname;
	                }
	                else {
		                var code = data._response.jqXHR.responseText;
		                document.open("text/html", "replace");
		                document.write(code);
		                document.close();
	                }
	            },
	            progressall: function(e, data) {
	                var progress = parseInt(data.loaded / data.total * 100, 10);
	                $("#file_upload_bar").css(
	                    "width", progress + '%'
	                );
	            }
	        });
	    });

	    $("#settings_general_form").submit(function(event) {
	        if (settings_general_files.length > 0)
	        {
	            event.preventDefault();
	            $("#settings_load_avatar_input").fileupload('send', { files: settings_general_files, formData: $('#settings_general_form').serializeArray() });
	        }
	    });
	</script>

{% endblock %}